<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.5.0/metricsgraphics.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.5.0/metricsgraphics.min.css">
<script>
    $(function() {
        $.getJSON("commits.json", function(data) {
            var commits_monthly = {};
            // Count the number of commits per month
            for (var i in data) {
                var date = new Date(data[i].timestamp*1000);
                var firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                var key = firstDay.getFullYear() + '_' + firstDay.getMonth();
                if (commits_monthly[key] === undefined) {
                    commits_monthly[key] = {
                        'count': 1,
                        'date': firstDay,
                        'data': data[i]
                    };
                }
                else {
                    ++commits_monthly[key].count;
                }
            }
            // MetricGraphics.js requires a flat array of objects
            var commits_monthly_flat = [];
            for (var i in commits_monthly) {
                commits_monthly_flat.push(commits_monthly[i]);
            }
            // Mark the Drupal releases to get some context for spikes
            var markers = [
                {
                    'date': new Date('2002-6-25'),
                    'label': 'Drupal 4 released'
                },
                {
                    'date': new Date('2007-1-15'),
                    'label': 'Drupal 5 released'
                },
                {
                    'date': new Date('2008-2-13'),
                    'label': 'Drupal 6 released'
                },
                {
                    'date': new Date('2011-1-5'),
                    'label': 'Drupal 7 released'
                }
            ];
            // Create the graph
            MG.data_graphic({
                title: 'Acquia Contributions to Drupal Core',
                data: commits_monthly_flat,
                full_width: true,
                height: 600,
                target: '#chart',
                x_accessor: 'date',
                y_accessor: 'count',
                markers: markers
            });

            // Create list of top contributors this last month (30 days)
            var contributor_totals = {};
            var last_month = (Date.now()/1000) - 2592000;
            var total = 0;
            for (var i in data) {
                if (last_month <= data[i].timestamp) {
                    for (var j in data[i].contributors) {
                        var contributor = data[i].contributors[j];
                        if (contributor_totals[contributor.name] === undefined) {
                            contributor_totals[contributor.name] = 1;
                            ++total;
                        }
                        else {
                            ++contributor_totals[contributor.name];
                            ++total;
                        }
                    }
                }
            }
            // Sort totals
            var contributor_totals_sorted = [];
            // Flatten object into array
            for (var i in contributor_totals) {
                contributor_totals_sorted.push([i, contributor_totals[i]]);
            }
            // Sort array
            contributor_totals_sorted.sort(function(a, b) {
                a = a[1];
                b = b[1];

                return a > b ? -1 : (a < b ? 1 : 0);
            });
            // Display in list
            for (var i in contributor_totals_sorted) {
                var user = contributor_totals_sorted[i][0];
                var count = contributor_totals_sorted[i][1];
                $('#top ol').append('<li>' + user + ': ' + count + '</li>');
            }
        });
    });
</script>
<body>
    <div id="chart"></div>
    <div id="top">
        <h1>Top Contributors in last 30 days</h1>
        <ol></ol>
    </div>
</body>